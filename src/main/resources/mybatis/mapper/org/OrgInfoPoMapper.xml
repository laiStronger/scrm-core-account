<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="OrgInfoPoMapper" >
  <resultMap id="BaseResultMap" type="com.youanmi.scrm.core.account.po.org.OrgInfoPo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Dec 15 11:25:49 CST 2016.
    -->
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="parent_org_id" property="parentOrgId" jdbcType="BIGINT" />
    <result column="top_org_id" property="topOrgId" jdbcType="BIGINT" />
    <result column="org_full_name" property="orgFullName" jdbcType="VARCHAR" />
    <result column="org_name" property="orgName" jdbcType="VARCHAR" />
    <result column="org_type" property="orgType" jdbcType="TINYINT" />
    <result column="org_level" property="orgLevel" jdbcType="TINYINT" />
    <result column="org_path" property="orgPath" jdbcType="VARCHAR" />
    <result column="create_time" property="createTime" jdbcType="BIGINT" />
    <result column="update_time" property="updateTime" jdbcType="BIGINT" />
    <result column="is_forbid" property="isForbid" jdbcType="TINYINT" />
    <result column="is_delete" property="isDelete" jdbcType="TINYINT" />
    <result column="parent_org_name" property="parentOrgName" jdbcType="VARCHAR"/>
    <result column="address" property="address" jdbcType="VARCHAR"/>
    <result column="logo" property="logo" jdbcType="VARCHAR"/>
    <result column="thum_logo" property="thumLogo" jdbcType="VARCHAR"/>
    <result column="first_industry_id" property="firstIndustryId" jdbcType="BIGINT"/>
    <result column="second_industry_id" property="secondIndustryId" jdbcType="BIGINT"/>
    <result column="org_account" property="orgAccount" jdbcType="VARCHAR"/>
  </resultMap>
  <!-- 机构过期resultMap -->
	<resultMap id="OrgExpireTimeResultMap" type="com.youanmi.scrm.core.account.po.org.OrgInfoPo" extends="BaseResultMap">
	    <association property="orgExpireTime"  resultMap="OrgExpireTimePoMapper.BaseResultMap" columnPrefix="oet_"></association>
	</resultMap>
  <sql id="Base_Column_List" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Dec 15 11:25:49 CST 2016.
    -->
    id, parent_org_id, top_org_id, org_full_name, org_name, org_type, org_level, org_path, 
    create_time, update_time, is_forbid, is_delete, logo, thum_logo, first_industry_id, second_industry_id, org_account
  </sql>
  <select id="selectByPrimaryKey" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    select 
    <include refid="Base_Column_List" />
    from org_info
    where id = #{id,jdbcType=BIGINT} and is_delete = 1
  </select>

  <select id="selectByTopOrgId" resultMap="BaseResultMap" parameterType="java.lang.Long" >
    select
    <include refid="Base_Column_List" />
    from org_info
    where top_org_id = #{top_org_id,jdbcType=BIGINT} and is_delete = 1
  </select>

  <!-- 获取simpleDepartmentTree -->
  <select id="selectByParams" resultMap="BaseResultMap" parameterType="map">
  	select
    <include refid="Base_Column_List" />
    from org_info
    where is_delete = 1 
    <if test="topOrgId != null and '' != topOrgId">
    	and top_org_id = #{topOrgId,jdbcType=BIGINT}
    </if>
    <if test="orgPath != null and '' != orgPath">
    	and (CASE WHEN org_path is null or org_path = '' THEN id ELSE CONCAT(org_path,id) END) like concat(#{orgPath,jdbcType=VARCHAR} ,'%')
    </if>
    <if test="orgType != null and '' != orgType">
    	and org_type = #{orgType,jdbcType=BIGINT}
    </if>
    <if test="orderByField != null and ''!=orderByField" >
      order by ${orderByField} 
      <if test="orderBy != null and '' != orderBy" >
        ${orderBy} 
      </if>
    </if>
  </select>

  <delete id="deleteByPrimaryKey" parameterType="com.youanmi.scrm.core.account.po.org.OrgInfoPo" >
    update org_info
    set is_delete = 2,
        update_time = #{updateTime}
    where id = #{id,jdbcType=BIGINT} and is_delete = 1
  </delete>
  <insert id="insert" parameterType="com.youanmi.scrm.core.account.po.org.OrgInfoPo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Dec 15 11:25:49 CST 2016.
    -->
    insert into org_info (id, parent_org_id, top_org_id, 
      org_full_name, org_name, org_type, 
      org_level, org_path, create_time, 
      update_time, is_forbid, is_delete
      )
    values (#{id,jdbcType=BIGINT}, #{parentOrgId,jdbcType=BIGINT}, #{topOrgId,jdbcType=BIGINT}, 
      #{orgFullName,jdbcType=VARCHAR}, #{orgName,jdbcType=VARCHAR}, #{orgType,jdbcType=TINYINT}, 
      #{orgLevel,jdbcType=TINYINT}, #{orgPath,jdbcType=VARCHAR}, #{createTime,jdbcType=BIGINT}, 
      #{updateTime,jdbcType=BIGINT}, #{isForbid,jdbcType=TINYINT}, #{isDelete,jdbcType=TINYINT}
      )
  </insert>
    <insert id="insertSelective" useGeneratedKeys="true" keyProperty="id" parameterType="com.youanmi.scrm.core.account.po.org.OrgInfoPo" >
        insert into org_info
        <trim prefix="(" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                id,
            </if>
            <if test="parentOrgId != null" >
                parent_org_id,
            </if>
            <if test="topOrgId != null" >
                top_org_id,
            </if>
            <if test="orgFullName != null" >
                org_full_name,
            </if>
            <if test="orgName != null" >
                org_name,
            </if>
            <if test="orgType != null" >
                org_type,
            </if>
            <if test="orgLevel != null" >
                org_level,
            </if>
            <if test="orgPath != null" >
                org_path,
            </if>
            <if test="createTime != null" >
                create_time,
            </if>
            <if test="updateTime != null" >
                update_time,
            </if>
            <if test="isForbid != null" >
                is_forbid,
            </if>
            <if test="isDelete != null" >
                is_delete,
            </if>
            <if test="logo != null" >
                logo,
            </if>
            <if test="thumLogo != null" >
                thum_logo,
            </if>
            <if test="firstIndustryId != null" >
                first_industry_id,
            </if>
            <if test="secondIndustryId != null" >
                second_industry_id,
            </if>
            <if test="orgAccount != null" >
                org_account,
            </if>
        </trim>
        <trim prefix="values (" suffix=")" suffixOverrides="," >
            <if test="id != null" >
                #{id,jdbcType=BIGINT},
            </if>
            <if test="parentOrgId != null" >
                #{parentOrgId,jdbcType=BIGINT},
            </if>
            <if test="topOrgId != null" >
                #{topOrgId,jdbcType=BIGINT},
            </if>
            <if test="orgFullName != null" >
                #{orgFullName,jdbcType=VARCHAR},
            </if>
            <if test="orgName != null" >
                #{orgName,jdbcType=VARCHAR},
            </if>
            <if test="orgType != null" >
                #{orgType,jdbcType=TINYINT},
            </if>
            <if test="orgLevel != null" >
                #{orgLevel,jdbcType=TINYINT},
            </if>
            <if test="orgPath != null" >
                #{orgPath,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null" >
                #{createTime,jdbcType=BIGINT},
            </if>
            <if test="updateTime != null" >
                #{updateTime,jdbcType=BIGINT},
            </if>
            <if test="isForbid != null" >
                #{isForbid,jdbcType=TINYINT},
            </if>
            <if test="isDelete != null" >
                #{isDelete,jdbcType=TINYINT},
            </if>
            <if test="logo != null" >
                #{logo,jdbcType=VARCHAR},
            </if>
            <if test="thumLogo != null" >
                #{thumLogo,jdbcType=VARCHAR},
            </if>
            <if test="firstIndustryId != null" >
                #{firstIndustryId,jdbcType=BIGINT},
            </if>
            <if test="secondIndustryId != null" >
                #{secondIndustryId,jdbcType=BIGINT},
            </if>
            <if test="orgAccount != null" >
                #{orgAccount,jdbcType=VARCHAR},
            </if>
        </trim>
    </insert>
    <update id="updateByPrimaryKeySelective" parameterType="com.youanmi.scrm.core.account.po.org.OrgInfoPo" >
        update org_info
        <set >
            <if test="parentOrgId != null" >
                parent_org_id = #{parentOrgId,jdbcType=BIGINT},
            </if>
            <if test="topOrgId != null" >
                top_org_id = #{topOrgId,jdbcType=BIGINT},
            </if>
            <if test="orgFullName != null" >
                org_full_name = #{orgFullName,jdbcType=VARCHAR},
            </if>
            <if test="orgName != null" >
                org_name = #{orgName,jdbcType=VARCHAR},
            </if>
            <if test="orgType != null" >
                org_type = #{orgType,jdbcType=TINYINT},
            </if>
            <if test="orgLevel != null" >
                org_level = #{orgLevel,jdbcType=TINYINT},
            </if>
            <if test="orgPath != null" >
                org_path = #{orgPath,jdbcType=VARCHAR},
            </if>
            <if test="createTime != null" >
                create_time = #{createTime,jdbcType=BIGINT},
            </if>
            <if test="updateTime != null" >
                update_time = #{updateTime,jdbcType=BIGINT},
            </if>
            <if test="isForbid != null" >
                is_forbid = #{isForbid,jdbcType=TINYINT},
            </if>
            <if test="isDelete != null" >
                is_delete = #{isDelete,jdbcType=TINYINT},
            </if>
            <if test="logo != null" >
                logo = #{logo,jdbcType=VARCHAR},
            </if>
            <if test="thumLogo != null" >
                thum_logo = #{thumLogo,jdbcType=VARCHAR},
            </if>
            <if test="firstIndustryId != null" >
                first_industry_id = #{firstIndustryId,jdbcType=BIGINT},
            </if>
            <if test="secondIndustryId != null" >
                second_industry_id = #{secondIndustryId,jdbcType=BIGINT},
            </if>
            <if test="orgAccount != null" >
                org_account = #{orgAccount,jdbcType=VARCHAR},
            </if>
        </set>
        where id = #{id,jdbcType=BIGINT}
</update>
  <update id="updateByPrimaryKey" parameterType="com.youanmi.scrm.core.account.po.org.OrgInfoPo" >
    <!--
      WARNING - @mbggenerated
      This element is automatically generated by MyBatis Generator, do not modify.
      This element was generated on Thu Dec 15 11:25:49 CST 2016.
    -->
    update org_info
    set parent_org_id = #{parentOrgId,jdbcType=BIGINT},
      top_org_id = #{topOrgId,jdbcType=BIGINT},
      org_full_name = #{orgFullName,jdbcType=VARCHAR},
      org_name = #{orgName,jdbcType=VARCHAR},
      org_type = #{orgType,jdbcType=TINYINT},
      org_level = #{orgLevel,jdbcType=TINYINT},
      org_path = #{orgPath,jdbcType=VARCHAR},
      create_time = #{createTime,jdbcType=BIGINT},
      update_time = #{updateTime,jdbcType=BIGINT},
      is_forbid = #{isForbid,jdbcType=TINYINT},
      is_delete = #{isDelete,jdbcType=TINYINT}
    where id = #{id,jdbcType=BIGINT}
  </update>
  <!-- 获取所有非直属部门id -->
  <select id="getAllParentOrg" resultType="java.lang.String" parameterType="java.lang.Long">
        SELECT DISTINCT parent_org_id
        FROM
            org_info
        WHERE
            is_delete = 1
        AND
            org_type = 1
        AND
            top_org_id = #{topOrgId}
  </select>
    <!-- 获取直属部门id -->
    <select id="getDirectOrg" parameterType="java.util.Map" resultMap="BaseResultMap">
        select
            id,org_name
        FROM
            org_info
        where
            top_org_id = #{topOrgId}
        AND
            id not in
        <foreach collection="parentOrg" item="item" index="index" open="(" close=")" separator=",">
            #{item}
        </foreach>
          and
            is_delete = 1
          and
            org_type = 1
        ORDER by create_time desc
    </select>
    
    <!-- 根据id查询机构 -->
    <select id="getOrgById" parameterType="java.lang.Long" resultMap="BaseResultMap">
        select
            <include refid="Base_Column_List" />
        	from
            	org_info
       		where id = #{id,jdbcType=BIGINT} and
       				is_delete = 1
    </select>
    
      <!-- 员工id获取机构实体  -->
    <select id="getOrgByStaffId" parameterType="java.lang.Long" resultMap="BaseResultMap">
		select o.* from org_staff s inner join org_info o on o.id = s.org_id
        where s.is_delete = 1 
        and o.is_delete = 1
        and s.id = #{staffId,jdbcType=BIGINT}
	</select>
	<!-- 获取门店的管理员账号 -->
    <select id="getAdminByOrg" parameterType="java.util.List" resultType="java.util.Map">
        SELECT
	        ui.user_name as userName,
            os.org_id as orgId
        FROM
	        user_info ui
        LEFT JOIN org_staff os ON ui.id = os.user_id
        LEFT JOIN org_post opp ON opp.id = os.post_id
        WHERE
	        opp.post_type = 1
        AND ui.is_delete = 1
        AND os.is_delete = 1
        AND opp.is_delete = 1
        AND os.org_id in
        <foreach collection="list" index="index" item="item" separator="," open="(" close=")">
            #{item}
        </foreach>
    </select>
    <!-- 获取门店的店员数 -->
    <select id="getStaffCountByOrg" parameterType="java.util.List" resultType="java.util.Map">
        SELECT
	        count(1) as count,
	        org_id as orgId
        FROM
	        org_staff
        WHERE
            is_delete = 1
        AND
            org_id in
            <foreach collection="list" index="index" separator="," item="item" open="(" close=")">
                #{item}
            </foreach>
        group by org_id
    </select>

  <select id="getOrgChildOrgType" parameterType="java.lang.Long" resultType="java.lang.Byte">
    SELECT  org_type  FROM
      org_info
    WHERE
     parent_org_id = #{parentId}
    AND is_delete = 1 limit 1;
  </select>

  <!-- 分页查询门店列表 -->
  <select id="getShopList" parameterType="com.youanmi.commons.base.vo.PageBean" resultMap="BaseResultMap">
      SELECT
	    oi.id,
	    oi.org_name,
	    CONCAT(
		  odi.province_name,
		  odi.city_name,
		  odi.area_name,
		  odi.address
	    ) address,
	    oi1.org_name parent_org_name
      FROM
	    org_info oi
      LEFT JOIN org_detail_info odi ON oi.id = odi.org_id
      LEFT JOIN org_info oi1 ON oi.parent_org_id = oi1.id
      where oi.is_delete = 1 and oi.is_forbid = 1
      and oi.org_type = 2
      <if test="paramObject.parentOrgId != null">
          and oi.parent_org_id = #{paramObject.parentOrgId}
      </if>
      <if test="paramObject.topOrgId != null">
          and oi.top_org_id = #{paramObject.topOrgId}
      </if>
      <if test="paramObject.orgName != null and paramObject.orgName !=''">
          and oi.org_name like concat('%',#{paramObject.orgName} ,'%')
      </if>
      <if test="paramObject.provinceId != null">
          and odi.province_id = #{paramObject.provinceId}
      </if>
      <if test="paramObject.cityId != null">
          and odi.city_id = #{paramObject.cityId}
      </if>
      <if test="paramObject.areaId != null">
          and odi.area_id = #{paramObject.areaId}
      </if>
      order by oi.create_time DESC
  </select>
    <!-- 获取一个连锁体系下除某个门店以外的门店 -->
    <select id="getOtherOrg" parameterType="java.util.Map" resultMap="BaseResultMap">
        SELECT
	        id,
	        org_name
        FROM
	        org_info
        WHERE
	        id != #{orgId}
        AND top_org_id = #{topOrgId}
        and org_type = 2
        ORDER  by create_time desc
    </select>
    <!-- 获取某个组织架构下的所有门店 -->
    <select id="selectShopByTopOrg" resultMap="BaseResultMap" parameterType="java.lang.Long" >
        select
        id,org_name
        from org_info
        where top_org_id = #{topOrgId,jdbcType=BIGINT}
        and is_delete = 1
        and org_type = 2
    </select>
    <!-- 根据名称和topOrgId查部门,用来作部门名称唯一性校验 -->
    <select id="selectIdByTopOrgAndNameAndOrgType" resultType="java.lang.Long" parameterType="com.youanmi.scrm.core.account.po.org.OrgInfoPo" >
        select
        id
        from org_info
        where top_org_id = #{topOrgId,jdbcType=BIGINT}
        and is_delete = 1
        and org_name =  #{orgName,jdbcType=BIGINT}
        and org_type = #{orgType}
    </select>
    
    <!-- 根据topId和id查询机构是否存在 -->
    <select id="isExistOrgByTopIdAndId" resultType="java.lang.Integer" parameterType="com.youanmi.scrm.core.account.po.org.OrgInfoPo" >
        select count(*)
        	from org_info
        		where top_org_id = #{topOrgId,jdbcType=BIGINT}
        			and id = #{id,jdbcType=BIGINT}
        			and org_type = #{orgType,jdbcType=TINYINT}
        			and is_delete = 1
    </select>
    
    <!-- 根据顶级id&机构类型查询机构列表 -->
    <select id="selectListByTopIdAndOrgType" resultMap="BaseResultMap" parameterType="com.youanmi.scrm.core.account.po.org.OrgInfoPo" >
        select id,org_name
        	from org_info
        		where top_org_id = #{topOrgId,jdbcType=BIGINT}
        			and org_type = #{orgType,jdbcType=TINYINT}
        			and org_level != 1 
        			and is_delete = 1
        		order by id desc
    </select>
    <!-- 根据名称查找当前连锁机构下的门店 -->
    <select id="getShopByTopOrgAndName" parameterType="java.util.Map" resultType="java.lang.Long">
        SELECT id from org_info where top_org_id = #{topOrgId} and org_name = #{orgName} and org_type = 2
    </select>
    
    <!-- UNIQUENE_BY_ORG_NAME  根据OrgName判断是否唯一机构简称   没有排除isdelete-->
    <select id="uniqueneByOrgParams" parameterType="java.util.Map" resultType="java.lang.Integer">
        SELECT count(1) from org_info org 
        LEFT JOIN org_detail_info detail on org.id = detail.org_id
        where 1=1 
        <if test="orgName != null and '' != orgName">
			AND org.org_name = #{orgName,jdbcType=VARCHAR} 
		</if>
		<if test="businessLicense != null and '' != businessLicense">
			AND detail.business_license = #{businessLicense,jdbcType=VARCHAR}
		</if>
		<if test="orgId != null and '' != orgId">
			AND org.id != #{orgId,jdbcType=BIGINT}
		</if>
		<if test="topOrgId != null and '' != topOrgId">
			AND org.top_org_id = #{topOrgId,jdbcType=BIGINT}
		</if>
		<if test="orgType != null and '' != orgType">
			AND org.org_type = #{orgType,jdbcType=BIGINT}
		</if>
		<if test="notOrgType != null and '' != notOrgType">
			AND org.org_type != #{notOrgType,jdbcType=BIGINT}
		</if>
		<if test="orgLevel != null and '' != orgLevel">
			AND org.org_level = #{orgLevel,jdbcType=BIGINT}
		</if>
    </select>
    
    <!-- 根据顶级机构id、机构id和机构类型查询机构信息 -->
    <select id="selectOrgByTopOrgAndOrgIdAndOrgType" resultMap="BaseResultMap" parameterType="com.youanmi.scrm.core.account.po.org.OrgInfoPo" >
        select <include refid="Base_Column_List" />
        	from org_info
        		where top_org_id = #{topOrgId,jdbcType=BIGINT}
        			and id = #{id,jdbcType=BIGINT}
        			and org_type = #{orgType,jdbcType=TINYINT}
        			and is_delete = 1
    </select>

    <select id="getChildShopIds" resultType="java.lang.Long" parameterType="java.lang.Long">
        select id from org_info
        where org_path like '%'#{orgId}'%'
    </select>
    
    
    <!-- 根据机构路径和机构顶级id获取各层级对应的门店id和门店数量 -->
    <select id="selectShopIdsAndCountByDeptId" resultType="com.youanmi.scrm.api.account.dto.org.DeptShopIdsAndCountDto" parameterType="map">
		SELECT
			dept.id as deptId,
			group_concat(shop.id) as shopIds,
		    COUNT(shop.id) as shopCount
		FROM
			(
				SELECT
					*
				FROM
					org_info temp_org
				WHERE
					temp_org.top_org_id = #{topOrgId,jdbcType=BIGINT}
				AND temp_org.org_type = 1 
				AND temp_org.is_delete = 1 
				<if test="orgPath != null and '' != orgPath">
					AND (CASE WHEN temp_org.org_path IS NULL OR temp_org.org_path = '' THEN temp_org.id ELSE  CONCAT(temp_org.org_path,temp_org.id) END) LIKE CONCAT(#{orgPath,jdbcType=VARCHAR},'%')
				</if>
			) dept
		LEFT JOIN (
			SELECT
				*
			FROM
				org_info temp_shop
			WHERE
				temp_shop.top_org_id = #{topOrgId,jdbcType=BIGINT}
			AND temp_shop.org_type = 2 
			AND temp_shop.is_delete = 1 
			<if test="orgPath != null and '' != orgPath">
				AND (CASE WHEN temp_shop.org_path IS NULL OR temp_shop.org_path = '' THEN temp_shop.id ELSE  CONCAT(temp_shop.org_path,temp_shop.id) END ) LIKE CONCAT(#{orgPath,jdbcType=VARCHAR},'%')
			</if>
		) shop ON locate(CASE WHEN dept.org_path is null or dept.org_path = '' then dept.id else CONCAT(dept.org_path,dept.id) END,shop.org_path) = 1
		GROUP BY dept.id
    </select>
    
    
    <resultMap id="BranchOrgMap" type="com.youanmi.scrm.api.account.dto.org.BranchOrgDto" >
    <id column="id" property="id" jdbcType="BIGINT" />
    <result column="create_time" property="createTime" jdbcType="BIGINT" />
    <result column="org_account" property="orgAccount" jdbcType="VARCHAR" />
    <result column="orgName" property="orgName" jdbcType="VARCHAR" />
    <result column="topOrgName" property="topOrgName" jdbcType="VARCHAR" />
    <result column="first_industry_id" property="firstIndustryId" jdbcType="BIGINT" />
    <result column="second_industry_id" property="secondIndustryId" jdbcType="BIGINT" />
    <result column="staffCount" property="staffCount" jdbcType="VARCHAR" />
  </resultMap>
  
    <!-- 连锁分店查询 -->
    <select id="branchOrgList" resultMap="BranchOrgMap" parameterType="com.youanmi.scrm.api.account.dto.org.SelectBranchOrgDto" >
            select oi.id,oi.create_time,oi.org_account,oi.org_name as orgName ,toi.org_name as topOrgName,oi.first_industry_id as first_industry_id,oi.second_industry_id as second_industry_id,
            (select count(*) from org_staff os where os.org_id = oi.id and os.is_delete = 1) as staffCount
            from org_info oi 
			left join org_info toi on oi.top_org_id = toi.id
			left join org_detail_info od on oi.id = od.org_id
			where oi.is_delete = 1
			and oi.is_forbid = 1
			and oi.org_type = 2
			
			<if test="accountOrName == 0 and key != null and '' != key">
				and oi.org_account like concat('%',#{key} ,'%')
			</if>
			
			<if test="accountOrName == 1 and key != null and '' != key">
				and oi.org_name like concat('%',#{key} ,'%')
			</if>
			
			<if test="topOrgName != null and '' != topOrgName">
				and toi.org_name like concat('%',#{topOrgName} ,'%')
			</if>
			
			<if test="startTimeStamp != null">
	              and oi.create_time >= #{startTimeStamp,jdbcType=BIGINT}
            </if>
             
            <if test="endTimeStamp != null">
                  and #{endTimeStamp,jdbcType=BIGINT} >= oi.create_time 
            </if>
			
			<if test="firstIndustryId != null">
                  and oi.first_industry_id = #{firstIndustryId,jdbcType=BIGINT} 
            </if>
            
			<if test="secondIndustryId != null">
                  and oi.second_industry_id = #{secondIndustryId,jdbcType=BIGINT} 
            </if>
            
			<if test="provinceId != null">
                  and od.province_id = #{provinceId,jdbcType=BIGINT} 
            </if>
            
			<if test="cityId != null">
                  and od.city_id = #{cityId,jdbcType=BIGINT} 
            </if>
            
			<if test="areaId != null">
                  and od.area_id = #{areaId,jdbcType=BIGINT} 
            </if>
			
			order by oi.create_time desc
			limit #{startIndex},#{pageSize}
    </select>
    
    <!-- 连锁分店数量 -->
    <select id="branchOrgCount" resultType="java.lang.Long" parameterType="com.youanmi.scrm.api.account.dto.org.SelectBranchOrgDto" >
            select count(*) as count
            from org_info oi 
			left join org_info toi on oi.top_org_id = toi.id
			left join org_detail_info od on oi.id = od.org_id
			where oi.is_delete = 1
			and oi.is_forbid = 1
			and oi.org_type = 2
			
			<if test="accountOrName == 0 and key != null and '' != key">
				and oi.org_account like concat('%',#{key} ,'%')
			</if>
			
			<if test="accountOrName == 1 and key != null and '' != key">
				and oi.org_name like concat('%',#{key} ,'%')
			</if>
			
			<if test="topOrgName != null and '' != topOrgName">
				and toi.org_name like concat('%',#{topOrgName} ,'%')
			</if>
			
			<if test="startTimeStamp != null">
	              and oi.create_time >= #{startTimeStamp,jdbcType=BIGINT}
            </if>
             
            <if test="endTimeStamp != null">
                  and #{endTimeStamp,jdbcType=BIGINT} >= oi.create_time 
            </if>
			
			<if test="firstIndustryId != null">
                  and oi.first_industry_id = #{firstIndustryId,jdbcType=BIGINT} 
            </if>
            
			<if test="secondIndustryId != null">
                  and oi.second_industry_id = #{secondIndustryId,jdbcType=BIGINT} 
            </if>
            
			<if test="provinceId != null">
                  and od.province_id = #{provinceId,jdbcType=BIGINT} 
            </if>
            
			<if test="cityId != null">
                  and od.city_id = #{cityId,jdbcType=BIGINT} 
            </if>
            
			<if test="areaId != null">
                  and od.area_id = #{areaId,jdbcType=BIGINT} 
            </if>
			
    </select>
    
    <resultMap id="GetBranchOrgMap" type="com.youanmi.scrm.api.account.dto.org.BranchOrgDetailDto" >
	    <id column="id" property="id" jdbcType="BIGINT" />
	    <result column="org_account" property="orgAccount" jdbcType="VARCHAR" />
	    <result column="orgName" property="orgName" jdbcType="VARCHAR" />
	    <result column="businessLicense" property="businessLicense" jdbcType="VARCHAR" />
	    <result column="province_name" property="provinceName" jdbcType="VARCHAR" />
	    <result column="city_name" property="cityName" jdbcType="VARCHAR" />
	    <result column="area_name" property="areaName" jdbcType="VARCHAR" />
	    <result column="address" property="address" jdbcType="VARCHAR" />
	    <result column="topOrgName" property="topOrgName" jdbcType="VARCHAR" />
	    <result column="firstIndustryId" property="firstIndustryId" jdbcType="BIGINT" />
	    <result column="secondIndustryId" property="secondIndustryId" jdbcType="BIGINT" />
	    <result column="parentOrgName" property="parentOrgName" jdbcType="VARCHAR" />
	    <result column="create_time" property="createTime" jdbcType="BIGINT" />
	    <result column="thum_logo" property="thumLogo" jdbcType="VARCHAR" />
    </resultMap>
  
    <!-- 连锁分店详情 -->
    <select id="getBranchOrgDetail" resultMap="GetBranchOrgMap" parameterType="java.lang.Long" >
        select oi.id,oi.create_time,oi.org_account,oi.org_name as orgName ,toi.org_name as topOrgName,poi.org_name as parentOrgName,
		oi.first_industry_id as firstIndustryId,oi.second_industry_id as secondIndustryId,
		od.business_license,od.province_name,od.city_name,od.area_name,od.address,oi.thum_logo
		from org_info oi
		left join org_detail_info od on oi.id = od.org_id 
		left join org_info toi on oi.top_org_id = toi.id
		left join org_info poi on oi.parent_org_id = poi.id
		where oi.id = #{orgId,jdbcType=BIGINT}
    </select>
    
    <!-- 分页条件查询机构列表 -->
    <select id="selectOrgListByCondition" resultMap="OrgExpireTimeResultMap" parameterType="java.util.Map" >
		select oi.*,oet.expire_time oet_expire_time from org_info oi
			left join org_detail_info odi on odi.org_id = oi.id
			left join org_expire_time oet on oi.top_org_id=oet.top_org_id
				where oi.org_type = #{orgType,jdbcType=TINYINT} and org_level=1 and oi.is_delete=1
			<if test="orgAccount != null and orgAccount != ''">
				and oi.org_account like concat('%',#{orgAccount} ,'%')
			</if>
			<if test="orgFullName != null and orgFullName != ''">
				and oi.org_full_name like concat('%',#{orgFullName} ,'%')
			</if>
            <if test="startCreateTime != null">
	              and oi.create_time >= #{startCreateTime,jdbcType=BIGINT}
            </if>
            <if test="endCreateTime != null">
                  and #{endCreateTime,jdbcType=BIGINT} >= oi.create_time 
            </if>
			<if test="firstIndustryId != null">
                  and oi.first_industry_id = #{firstIndustryId,jdbcType=BIGINT} 
            </if>
			<if test="secondIndustryId != null">
                  and oi.second_industry_id = #{secondIndustryId,jdbcType=BIGINT} 
            </if>
			<if test="provinceId != null">
                  and odi.province_id = #{provinceId,jdbcType=BIGINT} 
            </if>
			<if test="cityId != null">
                  and odi.city_id = #{cityId,jdbcType=BIGINT} 
            </if>
			<if test="areaId != null">
                  and odi.area_id = #{areaId,jdbcType=BIGINT} 
            </if>
			<if test="startExpireTime != null">
                  and oet.expire_time >= #{startExpireTime,jdbcType=BIGINT} 
            </if>
			<if test="endExpireTime != null">
                  and #{endExpireTime,jdbcType=BIGINT} >= oet.expire_time
            </if>
			order by oi.create_time desc
    </select>
    
    <!-- 获取机构分店总数 -->
    <select id="getCountShopByTopOrg" resultType="java.lang.Long" parameterType="java.lang.Long">
        select count(*) from org_info oi 
			where oi.top_org_id=#{topOrgId,jdbcType=BIGINT} 
				and org_type=2 and oi.is_delete=1
    </select>
    
    <!-- 删除机构 -->
    <update id="deleteOrgsByTopOrgId" parameterType="java.util.Map">
    	update org_info
    		set update_time = #{updateTime,jdbcType=BIGINT},
      			is_delete = 2
			where top_org_id = #{topOrgId,jdbcType=BIGINT} and is_delete=1
  </update>
</mapper>