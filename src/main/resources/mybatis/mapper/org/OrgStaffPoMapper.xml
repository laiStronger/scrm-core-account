<?xml version="1.0" encoding="UTF-8" ?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd" >
<mapper namespace="OrgStaffPoMapper">
	<resultMap id="BaseResultMap"
		type="com.youanmi.scrm.core.account.po.org.OrgStaffPo">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Dec 15 
			11:25:49 CST 2016. -->
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="staff_name" property="staffName" jdbcType="VARCHAR" />
		<result column="user_id" property="userId" jdbcType="BIGINT" />
		<result column="org_id" property="orgId" jdbcType="BIGINT" />
		<result column="top_org_id" property="topOrgId" jdbcType="BIGINT" />
		<result column="last_login_time" property="lastLoginTime"
			jdbcType="BIGINT" />
		<result column="post_id" property="postId" jdbcType="BIGINT" />
		<result column="creater_id" property="createrId" jdbcType="BIGINT" />
		<result column="create_time" property="createTime" jdbcType="BIGINT" />
		<result column="update_time" property="updateTime" jdbcType="BIGINT" />
		<result column="is_delete" property="isDelete" jdbcType="TINYINT" />
	</resultMap>
	
	<!-- 员工、机构、用户resultMap -->
	<resultMap id="StaffOrgUserResultMap" type="com.youanmi.scrm.core.account.po.org.OrgStaffPo" extends="BaseResultMap">
	    <association property="userInfo"  resultMap="UserInfoPoMapper.BaseResultMap" columnPrefix="ui_"></association>
	    <association property="orgInfo"  resultMap="OrgInfoPoMapper.BaseResultMap" columnPrefix="oi_"></association>
	</resultMap>

	<resultMap id="BaseResultMap_Dto"
		type="com.youanmi.scrm.api.account.dto.org.OrgStaffDetailDto">
		<id column="id" property="id" jdbcType="BIGINT" />
		<result column="staff_name" property="staffName" jdbcType="VARCHAR" />
		<result column="user_id" property="userId" jdbcType="BIGINT" />
		<result column="org_id" property="orgId" jdbcType="BIGINT" />
		<result column="top_org_id" property="topOrgId" jdbcType="BIGINT" />
		<result column="last_login_time" property="lastLoginTime"
			jdbcType="BIGINT" />
		<result column="post_id" property="postId" jdbcType="BIGINT" />
		<result column="creater_id" property="createrId" jdbcType="BIGINT" />
		<result column="create_time" property="createTime" jdbcType="BIGINT" />
		<result column="update_time" property="updateTime" jdbcType="BIGINT" />
		<result column="is_delete" property="isDelete" jdbcType="TINYINT" />
		<!-- 用户信息 张秋平 2016-12-23 -->
		<association property="user" column="u_id"
			javaType="com.youanmi.scrm.api.account.dto.user.UserInfoDto">
			<id column="u_id" property="id" />
			<result column="u_user_name" property="userName" />
			<result column="u_mobile_phone" property="mobilePhone" />
			<result column="u_user_type" property="userType" />
		</association>
		<!-- 岗位信息 张秋平 2016-12-23 -->
		<association property="post"
			javaType="com.youanmi.scrm.api.account.dto.org.OrgPostDto" column="o_id">
			<id column="p_id" property="id" />
			<id column="p_post_name" property="postName" />
			<id column="p_post_type" property="postType" />
		</association>
	</resultMap>
	<sql id="Base_Column_List">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Dec 15 
			11:25:49 CST 2016. -->
		id, staff_name, user_id, org_id, top_org_id, last_login_time, post_id,
		creater_id,
		create_time, update_time, is_delete
	</sql>
	<select id="selectByPrimaryKey" resultMap="BaseResultMap"
		parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Dec 15 
			11:25:49 CST 2016. -->
		select
		<include refid="Base_Column_List" />
		from org_staff
		where id = #{id,jdbcType=BIGINT} and is_delete=1
	</select>

	<!--根据门店id和岗位查找店员-->
	<select id="selectByOrgAndPost" resultMap="BaseResultMap"
			parameterType="com.youanmi.scrm.core.account.po.org.OrgStaffPo">
		select
		<include refid="Base_Column_List" />
		from org_staff
		where is_delete = 1
		and org_id = #{orgId}
		and post_id = #{postId}
	</select>

	<select id="selectByTopOrgId" resultMap="BaseResultMap"
		parameterType="java.lang.Long">
		select
		<include refid="Base_Column_List" />
		from org_staff
		where top_org_id = #{topOrgId,jdbcType=BIGINT}
		and is_delete = 1
	</select>
	<delete id="deleteByPrimaryKey" parameterType="java.lang.Long">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Dec 15 
			11:25:49 CST 2016. -->
		delete from org_staff
		where id = #{id,jdbcType=BIGINT}
	</delete>
	<insert id="insert" parameterType="com.youanmi.scrm.core.account.po.org.OrgStaffPo">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Dec 15 
			11:25:49 CST 2016. -->
		insert into org_staff (id, staff_name, user_id,
		org_id, top_org_id,
		last_login_time,
		post_id, creater_id, create_time,
		update_time,
		is_delete)
		values (#{id,jdbcType=BIGINT},
		#{staffName,jdbcType=VARCHAR},
		#{userId,jdbcType=BIGINT},
		#{orgId,jdbcType=BIGINT}, #{topOrgId,jdbcType=BIGINT},
		#{lastLoginTime,jdbcType=BIGINT},
		#{postId,jdbcType=BIGINT},
		#{createrId,jdbcType=BIGINT},
		#{createTime,jdbcType=BIGINT},
		#{updateTime,jdbcType=BIGINT}, #{isDelete,jdbcType=TINYINT})
	</insert>
	<insert id="insertSelective" parameterType="com.youanmi.scrm.core.account.po.org.OrgStaffPo"
		useGeneratedKeys="true" keyProperty="id">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Dec 15 
			11:25:49 CST 2016. -->
		insert into org_staff
		<trim prefix="(" suffix=")" suffixOverrides=",">
			<if test="id != null">
				id,
			</if>
			<if test="staffName != null">
				staff_name,
			</if>
			<if test="userId != null">
				user_id,
			</if>
			<if test="orgId != null">
				org_id,
			</if>
			<if test="topOrgId != null">
				top_org_id,
			</if>
			<if test="lastLoginTime != null">
				last_login_time,
			</if>
			<if test="postId != null">
				post_id,
			</if>
			<if test="createrId != null">
				creater_id,
			</if>
			<if test="createTime != null">
				create_time,
			</if>
			<if test="updateTime != null">
				update_time,
			</if>
			<if test="isDelete != null">
				is_delete,
			</if>
		</trim>
		<trim prefix="values (" suffix=")" suffixOverrides=",">
			<if test="id != null">
				#{id,jdbcType=BIGINT},
			</if>
			<if test="staffName != null">
				#{staffName,jdbcType=VARCHAR},
			</if>
			<if test="userId != null">
				#{userId,jdbcType=BIGINT},
			</if>
			<if test="orgId != null">
				#{orgId,jdbcType=BIGINT},
			</if>
			<if test="topOrgId != null">
				#{topOrgId,jdbcType=BIGINT},
			</if>
			<if test="lastLoginTime != null">
				#{lastLoginTime,jdbcType=BIGINT},
			</if>
			<if test="postId != null">
				#{postId,jdbcType=BIGINT},
			</if>
			<if test="createrId != null">
				#{createrId,jdbcType=BIGINT},
			</if>
			<if test="createTime != null">
				#{createTime,jdbcType=BIGINT},
			</if>
			<if test="updateTime != null">
				#{updateTime,jdbcType=BIGINT},
			</if>
			<if test="isDelete != null">
				#{isDelete,jdbcType=TINYINT},
			</if>
		</trim>
	</insert>
	<update id="updateByPrimaryKeySelective" parameterType="com.youanmi.scrm.core.account.po.org.OrgStaffPo">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Dec 15 
			11:25:49 CST 2016. -->
		update org_staff
		<set>
			<if test="staffName != null">
				staff_name = #{staffName,jdbcType=VARCHAR},
			</if>
			<if test="userId != null">
				user_id = #{userId,jdbcType=BIGINT},
			</if>
			<if test="orgId != null">
				org_id = #{orgId,jdbcType=BIGINT},
			</if>
			<if test="topOrgId != null">
				top_org_id = #{topOrgId,jdbcType=BIGINT},
			</if>
			<if test="lastLoginTime != null">
				last_login_time = #{lastLoginTime,jdbcType=BIGINT},
			</if>
			<if test="postId != null">
				post_id = #{postId,jdbcType=BIGINT},
			</if>
			<if test="createrId != null">
				creater_id = #{createrId,jdbcType=BIGINT},
			</if>
			<if test="createTime != null">
				create_time = #{createTime,jdbcType=BIGINT},
			</if>
			<if test="updateTime != null">
				update_time = #{updateTime,jdbcType=BIGINT},
			</if>
			<if test="isDelete != null">
				is_delete = #{isDelete,jdbcType=TINYINT},
			</if>
		</set>
		where id = #{id,jdbcType=BIGINT}
	</update>
	<update id="updateByPrimaryKey" parameterType="com.youanmi.scrm.core.account.po.org.OrgStaffPo">
		<!-- WARNING - @mbggenerated This element is automatically generated by 
			MyBatis Generator, do not modify. This element was generated on Thu Dec 15 
			11:25:49 CST 2016. -->
		update org_staff
		set staff_name = #{staffName,jdbcType=VARCHAR},
		user_id = #{userId,jdbcType=BIGINT},
		org_id = #{orgId,jdbcType=BIGINT},
		top_org_id = #{topOrgId,jdbcType=BIGINT},
		last_login_time =
		#{lastLoginTime,jdbcType=BIGINT},
		post_id = #{postId,jdbcType=BIGINT},
		creater_id = #{createrId,jdbcType=BIGINT},
		create_time =
		#{createTime,jdbcType=BIGINT},
		update_time =
		#{updateTime,jdbcType=BIGINT},
		is_delete = #{isDelete,jdbcType=TINYINT}
		where id = #{id,jdbcType=BIGINT}
	</update>

	<!-- 根据用户id查询商户账号 -->
	<select id="getStaffByUserId" parameterType="java.lang.Long"
		resultMap="BaseResultMap">
		SELECT
		<include refid="Base_Column_List" />
		FROM
		org_staff
		WHERE
		is_delete = 1
		and
		user_id = #{userId,jdbcType=BIGINT}
	</select>
	<!-- 分页查询门店店员 -->
	<select id="getShopStaffList" parameterType="com.youanmi.commons.base.vo.PageBean"
		resultType="com.youanmi.scrm.core.account.po.org.OrgStaffDetailPo">
		select * from (SELECT
		os.id,
		os.org_id as orgId,
		oi.org_name as orgName,
		os.staff_name as staffName,
		os.user_id as userId,
		ui.user_name as userName,
		ui.mobile_phone as mobilePhone,
		opp.post_name as postName,
		opp.post_type as postType,
		os.create_time as createTime
		FROM
		org_staff os
		LEFT JOIN org_info oi ON os.org_id = oi.id
		LEFT JOIN user_info ui ON
		os.user_id = ui.id
		LEFT JOIN org_post opp ON os.post_id = opp.id
		WHERE
		os.is_delete = 1
		AND oi.is_delete = 1
		AND ui.is_delete = 1
		AND
		oi.org_type = 2
		<if test="paramObject.topOrgId != null">
			and os.top_org_id = #{paramObject.topOrgId}
		</if>
		<if test="paramObject.inputValue != null and paramObject.inputValue !=''">
			and ((ui.mobile_phone like concat("%", #{paramObject.inputValue} ,"%"))
			or (ui.user_name like concat("%",#{paramObject.inputValue},"%"))
			or (os.staff_name like concat("%",#{paramObject.inputValue},"%"))
			)
		</if>
		<if test="paramObject.orgId != null and paramObject.orgId != ''">
			and os.org_id = #{paramObject.orgId}
		</if>) s
		where s.postType is null or s.postType !=1
		ORDER by s.createTime DESC
	</select>
	<!-- 设置岗位为空 -->
	<update id="setPostNull" parameterType="java.lang.Long">
		update
		org_staff
		set
		post_id = NULL
		where
		id = #{id}
	</update>

	<!-- 修改为删除状态(逻辑删除) -->
	<update id="updateDeleteStatus" parameterType="com.youanmi.scrm.core.account.po.org.OrgStaffPo">
		update org_staff
		set is_delete = 2,
		update_time = #{updateTime,jdbcType=BIGINT}
		where id = #{id,jdbcType=BIGINT}
	</update>

	<select id="selectOrgClerkListForPage" parameterType="com.youanmi.commons.base.vo.PageBean"
		resultMap="BaseResultMap_Dto">
		select 
			os.id,
			os.staff_name,
			ui.id as u_id,
			ui.user_name as u_user_name,
			ui.mobile_phone as u_mobile_phone,
			ui.user_type as u_user_type,
			op.id as p_id,
			op.post_name as p_post_name,op.post_type p_post_type
		from (
				select id,staff_name,user_id,org_id,top_org_id,post_id,create_time
				from org_staff where org_id=#{paramObject.orgId} and is_delete=1
			) os
			LEFT JOIN user_info ui on os.user_id = ui.id and ui.is_delete=1
			LEFT JOIN org_post op on os.post_id = op.id and op.is_delete=1
		where (op.post_type in(2,3)
			<if test="paramObject != null">
			    <if test="paramObject.postId != null">
		       		and op.id = #{paramObject.postId}
		    	</if>
		    	<if test="paramObject.userName != null">
			        and (
			        	ui.user_name like CONCAT('%',#{paramObject.userName},'%')
			        	or 
			        	ui.mobile_phone like CONCAT('%',#{paramObject.userName},'%')
			        	or 
			        	os.staff_name like CONCAT('%',#{paramObject.userName},'%')
			        )
		    	</if >
			</if>
			) or op.id is null
		ORDER BY os.create_time desc
		limit #{startIndex},#{pageSize}
	</select>
	
	<select id="selectOrgClerkCountForPage" parameterType="com.youanmi.commons.base.vo.PageBean" resultType="java.lang.Integer" >
	    select 
			count(os.id)
		from (
				select id,staff_name,user_id,org_id,top_org_id,post_id
				from org_staff where org_id=#{paramObject.orgId} and is_delete=1
			) os
			LEFT JOIN user_info ui on os.user_id = ui.id and ui.is_delete=1
			LEFT JOIN org_post op on os.post_id = op.id and op.is_delete=1
		where (op.post_type in(2,3)
			<if test="paramObject != null">
			    <if test="paramObject.postId != null">
		       		and op.id = #{paramObject.postId}
		    	</if>
		    	<if test="paramObject.userName != null">
			        and (
			        	ui.user_name like CONCAT('%',#{paramObject.userName},'%')
			        	or 
			        	ui.mobile_phone like CONCAT('%',#{paramObject.userName},'%')
			        	or 
			        	os.staff_name like CONCAT('%',#{paramObject.userName},'%')
			        )
		    	</if >
			</if>
			) or op.id is null
	</select>

	<select id="selectOneStaffByOrgId" resultMap="BaseResultMap"
			parameterType="java.lang.Long">
		select
		<include refid="Base_Column_List"/>
		from org_staff
		where org_id = #{orgId,jdbcType=BIGINT} and is_delete = 1
		LIMIT  1
	</select>
	
	<!-- 分页查询机构员工列表 -->
	<select id="selectOrgStaffList" resultMap="StaffOrgUserResultMap"
			parameterType="java.util.Map">
		select 
				os.id,os.staff_name,os.user_id,os.org_id,os.top_org_id,os.post_id,
				ui.user_name ui_user_name,ui.mobile_phone ui_mobile_phone,
				oi.org_name oi_org_name
			from org_staff os 
				left join user_info ui on os.user_id=ui.id
				left join org_info oi on oi.id=os.org_id
			where os.top_org_id = #{topOrgId,jdbcType=BIGINT}
				and os.org_id != os.top_org_id
				and oi.org_type = #{orgType,jdbcType=TINYINT}
				<if test="orgId != null">
		       		and os.org_id = #{orgId,jdbcType=BIGINT}
		   		</if>
		   		<if test="value != null and value !=''">
					and 
					(
						ui.user_name like CONCAT('%',#{value,jdbcType=VARCHAR},'%')
						or ui.mobile_phone like CONCAT('%',#{value,jdbcType=VARCHAR},'%')
						or os.staff_name like CONCAT('%',#{value,jdbcType=VARCHAR},'%')
					)	
				</if>
				and os.is_delete = 1 and ui.is_delete=1 and oi.is_delete=1
			order by os.create_time desc
	</select>
	
		<select id="getOrgStaffPoListByPostId" parameterType="java.lang.Long" resultMap="BaseResultMap">
		select os.*
		from (select id from org_post where id=#{postId} and is_delete=1) op
		join org_staff os on op.id = os.post_id
		where os.is_delete=1
	</select>
	<!-- 查询指定门店的管理员最近登录时间-->
	<select id="getLastLoginTime" parameterType="java.util.List" resultType="java.util.Map">
		SELECT
			oi.id as orgId,
			os.last_login_time as lastLoginTime
		FROM
			org_info oi
		left join org_staff os
		on os.org_id = oi.id
		left JOIN org_post op
		on os.post_id = op.id
		WHERE
			oi.id in
			<foreach collection="list" open="(" close=")" separator="," item="item">
				#{item}
			</foreach>
		and
			op.post_type = 1
		and
			oi.is_delete = 1
		and
			os.is_delete = 1
		and
			op.is_delete = 1
	</select>
	<!-- 根据门店删除员工 -->
	<update id="deleteStaffByOrg" parameterType="java.util.Map" >
		  update org_staff
		  	set is_delete = 2,
		  		update_time = #{updateTime,jdbcType=BIGINT}
		  where
		  	org_id = #{id, jdbcType=BIGINT}

	</update>
	<!-- 根据顶级机构id -->
	<select id="getBasicStaffInfo" parameterType="java.lang.Long"
			resultType="com.youanmi.scrm.api.account.dto.user.UserInfoDto">
		SELECT
		ui.head_url as headUrl,
		ui.thum_head_url as thumHeadUrl,
		ui.gender as gender,
		ui.`name` as name,
		ui.birthday as birthday,
		op.post_name as postName,
		oi.org_name as orgName,
		ui.user_type as userType
		FROM

		org_staff os
		LEFT JOIN user_info ui ON os.user_id = ui.id
		LEFT JOIN org_post op ON os.post_id = op.id
		LEFT JOIN org_info oi ON os.org_id = oi.id
		WHERE
		os.id = #{id,jdbcType=BIGINT}
	</select>
	
	<!-- 查询分店、单店的员工 -->
	<select id="loadEmployeesByOrgId" parameterType="java.lang.Long" resultType="com.youanmi.scrm.api.account.dto.user.ShopEmployeeDto">
		SELECT
			u.id as userId,
			u.`name` as `name`,
			post.post_name as postName
		FROM
		org_staff staff
		LEFT JOIN user_info u ON staff.user_id = u.id
		LEFT JOIN org_post post ON staff.post_id = post.id
		WHERE
			post.post_type IN (2, 3)
		AND staff.org_id = #{orgId,jdbcType=BIGINT}
	</select>
	
    <!-- 获取机构员工总数,不包括管理员 -->
    <select id="getCountStaffByTopOrg" resultType="java.lang.Long" parameterType="java.lang.Long">
        select count(*) from org_staff os
			left join user_info ui on os.user_id=ui.id
				where os.top_org_id=#{topOrgId,jdbcType=BIGINT} and ui.user_type=1
					and os.is_delete=1 and ui.is_delete=1 
    </select>
</mapper>